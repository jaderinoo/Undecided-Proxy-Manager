# Proxy configuration template
# This file will be generated by the backend for each proxy
# Variables: {{.Domain}}, {{.TargetURL}}, {{.SSLEnabled}}, {{.WSEnabled}}, {{.SSLPath}}, {{.CertPath}}, {{.KeyPath}}, {{.IncludeBackend}}, {{.BackendURL}}

server {
    listen 80;
    server_name {{.Domain}};

    # ACME challenge location for Let's Encrypt (must allow all IPs for Let's Encrypt validation)
    location /.well-known/acme-challenge/ {
        allow all;
        root /var/www/html;
        try_files $uri =404;
    }

    # IP restrictions
    {{if .AllowedRanges}}
    {{range .AllowedRanges}}allow {{.}};
    {{end}}deny all;
    {{else}}
    # No IP restrictions - allow all
    {{end}}

    # Backend API routes (configurable)
    {{if .IncludeBackend}}
    location /api/ {
        proxy_pass {{.BackendURL}}/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    {{end}}

    # Redirect HTTP to HTTPS if SSL is enabled
    {{if .SSLEnabled}}
    return 301 https://$server_name$request_uri;
    {{else}}
    # HTTP proxy
    {{if .WSEnabled}}
    # Socket.IO WebSocket support (for Open WebUI and similar apps)
    # Handle /ws/socket.io/ path (Open WebUI default)
    # IMPORTANT: Proxy to /ws/socket.io/ on backend, not /socket.io/
    location /ws/socket.io/ {
        proxy_pass {{.TargetURL}}/ws/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Handle WebSocket upgrade - Socket.IO uses HTTP polling first, then upgrades to WebSocket
        # Preserve original Connection header for polling, upgrade for WebSocket
        proxy_set_header Upgrade $http_upgrade;
        # For Socket.IO: preserve original Connection header (for polling) or set upgrade (for WebSocket)
        proxy_set_header Connection $http_connection;
        proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
        proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
        proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;

        # Extended timeouts for Socket.IO
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache off;
    }
    
    # Handle /socket.io/ path (direct Socket.IO)
    location /socket.io/ {
        proxy_pass {{.TargetURL}}/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Handle WebSocket upgrade - Socket.IO uses HTTP polling first, then upgrades to WebSocket
        # Preserve original Connection header for polling, upgrade for WebSocket
        proxy_set_header Upgrade $http_upgrade;
        # For Socket.IO: preserve original Connection header (for polling) or set upgrade (for WebSocket)
        proxy_set_header Connection $http_connection;
        proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
        proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
        proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;

        # Extended timeouts for Socket.IO
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache off;
    }
    
    # General WebSocket support
    location /ws/ {
        proxy_pass {{.TargetURL}};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeouts
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # Disable buffering for WebSocket
        proxy_buffering off;
    }
    {{end}}
    location / {
        proxy_pass {{.TargetURL}};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Extended timeouts for streaming responses
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Disable buffering for streaming/SSE responses
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header X-Accel-Buffering no;
        
        # Enable chunked transfer encoding
        chunked_transfer_encoding on;
        
        # Preserve original request headers
        proxy_set_header Connection "";
    }
    {{end}}
}

{{if .SSLEnabled}}
server {
    listen 443 ssl;
    http2 on;
    server_name {{.Domain}};

    # SSL configuration
    ssl_certificate {{.CertPath}};
    ssl_certificate_key {{.KeyPath}};

    # SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # ACME challenge location for Let's Encrypt (must allow all IPs for Let's Encrypt validation)
    location /.well-known/acme-challenge/ {
        allow all;
        root /var/www/html;
        try_files $uri =404;
    }

    # IP restrictions
    {{if .AllowedRanges}}
    {{range .AllowedRanges}}allow {{.}};
    {{end}}deny all;
    {{else}}
    # No IP restrictions - allow all
    {{end}}

    # Backend API routes (configurable)
    {{if .IncludeBackend}}
    location /api/ {
        proxy_pass {{.BackendURL}}/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    {{end}}

    # HTTPS proxy
    {{if .WSEnabled}}
    # Socket.IO WebSocket support (for Open WebUI and similar apps)
    # Handle /ws/socket.io/ path (Open WebUI default)
    # IMPORTANT: Proxy to /ws/socket.io/ on backend, not /socket.io/
    location /ws/socket.io/ {
        proxy_pass {{.TargetURL}}/ws/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Handle WebSocket upgrade - Socket.IO uses HTTP polling first, then upgrades to WebSocket
        # Preserve original Connection header for polling, upgrade for WebSocket
        proxy_set_header Upgrade $http_upgrade;
        # For Socket.IO: preserve original Connection header (for polling) or set upgrade (for WebSocket)
        proxy_set_header Connection $http_connection;
        proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
        proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
        proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;

        # Extended timeouts for Socket.IO
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache off;
    }
    
    # Handle /socket.io/ path (direct Socket.IO)
    location /socket.io/ {
        proxy_pass {{.TargetURL}}/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Handle WebSocket upgrade - Socket.IO uses HTTP polling first, then upgrades to WebSocket
        # Preserve original Connection header for polling, upgrade for WebSocket
        proxy_set_header Upgrade $http_upgrade;
        # For Socket.IO: preserve original Connection header (for polling) or set upgrade (for WebSocket)
        proxy_set_header Connection $http_connection;
        proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
        proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
        proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;

        # Extended timeouts for Socket.IO
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache off;
    }
    
    # General WebSocket support
    location /ws/ {
        proxy_pass {{.TargetURL}};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeouts
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        
        # Disable buffering for WebSocket
        proxy_buffering off;
    }
    {{end}}
    location / {
        proxy_pass {{.TargetURL}};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Extended timeouts for streaming responses
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Disable buffering for streaming/SSE responses
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header X-Accel-Buffering no;
        
        # Enable chunked transfer encoding
        chunked_transfer_encoding on;
        
        # Preserve original request headers
        proxy_set_header Connection "";
    }
}
{{end}}
